<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ae="using:AvaloniaEdit"
             xmlns:vm="using:PipeForge.GUI.ViewModels"
             xmlns:conv="using:PipeForge.GUI.Converters"
             x:Class="PipeForge.GUI.Views.LiveRunView"
             x:DataType="vm:LiveRunViewModel">

    <UserControl.Resources>
        <conv:StepProgressStatusToBrushConverter x:Key="StatusBrush" />
    </UserControl.Resources>

    <DockPanel>
        <!-- Toolbar Row 1: Run controls -->
        <Border DockPanel.Dock="Top" Padding="8" Background="#181825">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Run Pipeline..."
                        Command="{Binding RunPipelineCommand}"
                        IsEnabled="{Binding !IsRunning}" />
                <Button Content="Restart"
                        Command="{Binding RestartCommand}" />
                <Button Content="Cancel"
                        Command="{Binding CancelRunCommand}"
                        IsEnabled="{Binding IsRunning}" />
                <Separator />
                <!-- Debug controls (always visible, enabled when paused) -->
                <Button Content="Continue (F5)"
                        Command="{Binding ContinueStepCommand}"
                        IsEnabled="{Binding IsPaused}" />
                <Button Content="Step (F10)"
                        Command="{Binding StepNextCommand}"
                        IsEnabled="{Binding IsPaused}" />
                <Button Content="Skip"
                        Command="{Binding SkipStepCommand}"
                        IsEnabled="{Binding IsPaused}" />
                <Button Content="Retry"
                        Command="{Binding RetryStepCommand}"
                        IsEnabled="{Binding IsPaused}" />
                <Button Content="Abort"
                        Command="{Binding AbortPipelineCommand}"
                        IsEnabled="{Binding IsPaused}" />
                <Separator />
                <Button Content="Source"
                        Command="{Binding ToggleSourceCommand}" />
            </StackPanel>
        </Border>

        <!-- Toolbar Row 2: Status -->
        <Border DockPanel.Dock="Top" Padding="8,4" Background="#181825">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding StatusText}"
                           VerticalAlignment="Center"
                           Foreground="#A6ADC8" />
                <TextBlock Text="{Binding StepProgressText}"
                           VerticalAlignment="Center"
                           Foreground="#89B4FA"
                           FontWeight="Bold" />
                <TextBlock Text="{Binding ElapsedText}"
                           VerticalAlignment="Center"
                           Foreground="#6C7086" />
            </StackPanel>
        </Border>

        <!-- Breakpoint Info Panel (visible when paused â€” info only, controls are in toolbar) -->
        <Border DockPanel.Dock="Top"
                IsVisible="{Binding IsPaused}"
                Background="#313244"
                Padding="12"
                Margin="0,0,0,4">
            <StackPanel Spacing="4">
                <TextBlock Text="BREAKPOINT" FontWeight="Bold" Foreground="#F9E2AF" FontSize="14" />
                <TextBlock Foreground="#CDD6F4">
                    <Run Text="{Binding BreakpointStageName}" />
                    <Run Text=" / " />
                    <Run Text="{Binding BreakpointStepName}" FontWeight="Bold" />
                </TextBlock>
                <TextBlock Text="{Binding BreakpointInfo}" Foreground="#A6ADC8" FontSize="12" />
            </StackPanel>
        </Border>

        <!-- Main content: Steps (left) + Output/Source (right) -->
        <Grid ColumnDefinitions="260,*">

            <!-- Step Progress Panel (full height left) -->
            <Border Grid.Column="0" Background="#1E1E2E" Padding="4">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               FontWeight="Bold"
                               Foreground="#CDD6F4"
                               Margin="4,4,4,8">
                        <Run Text="Steps" />
                        <Run Text="  (double-click to toggle breakpoint)" Foreground="#585B70" FontSize="11" FontWeight="Normal" />
                    </TextBlock>

                    <ListBox ItemsSource="{Binding StepProgress}"
                             Background="Transparent"
                             BorderThickness="0"
                             Name="StepListBox"
                             DoubleTapped="StepListBox_DoubleTapped">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:StepProgressItem">
                                <Grid ColumnDefinitions="20,20,*,Auto,Auto" Margin="0,2">
                                    <!-- Breakpoint indicator (red dot when set) -->
                                    <Ellipse Grid.Column="0"
                                             Width="10" Height="10"
                                             Fill="#F38BA8"
                                             IsVisible="{Binding HasBreakpoint}"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Center" />

                                    <!-- Current step indicator (yellow arrow) -->
                                    <TextBlock Grid.Column="1"
                                               Text="&#9654;"
                                               Foreground="#F9E2AF"
                                               FontSize="10"
                                               IsVisible="{Binding IsCurrent}"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center" />

                                    <!-- Step name -->
                                    <StackPanel Grid.Column="2" Spacing="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding StepName}"
                                                   Foreground="{Binding Status, Converter={StaticResource StatusBrush}}"
                                                   FontWeight="SemiBold"
                                                   FontSize="12" />
                                        <TextBlock Text="{Binding StageName}"
                                                   Foreground="#585B70"
                                                   FontSize="10" />
                                    </StackPanel>

                                    <!-- Duration -->
                                    <TextBlock Grid.Column="3"
                                               Text="{Binding Duration}"
                                               Foreground="#6C7086"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               Margin="8,0" />

                                    <!-- Exit code -->
                                    <TextBlock Grid.Column="4"
                                               Text="{Binding ExitCode}"
                                               Foreground="#6C7086"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               Margin="0,0,4,0" />
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Right side: Output + Source (vertical split with GridSplitter) -->
            <Grid Grid.Column="1" RowDefinitions="*,Auto,Auto">

                <!-- Output Log (top) -->
                <Border Grid.Row="0" Background="#11111B" Padding="4">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top"
                                   Text="Output"
                                   FontWeight="Bold"
                                   Foreground="#CDD6F4"
                                   Margin="4,4,4,8" />

                        <ListBox ItemsSource="{Binding OutputLines}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Name="OutputListBox">
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:OutputLineItem">
                                    <TextBlock Text="{Binding Text}"
                                               FontFamily="Cascadia Code,Consolas,Courier New"
                                               FontSize="12"
                                               Foreground="{Binding IsError, Converter={StaticResource BoolToColor}, ConverterParameter=#F38BA8|#BAC2DE}"
                                               TextWrapping="NoWrap" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <!-- GridSplitter (visible when source is shown) -->
                <GridSplitter Grid.Row="1"
                              Height="6"
                              Background="#313244"
                              IsVisible="{Binding ShowSource}"
                              ResizeDirection="Rows" />

                <!-- YAML Source Panel (collapsible) -->
                <Border Grid.Row="2"
                        IsVisible="{Binding ShowSource}"
                        Background="#11111B"
                        MinHeight="150"
                        Height="250"
                        Padding="4">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="12" Margin="4,4,4,8">
                            <TextBlock Text="Source"
                                       FontWeight="Bold"
                                       Foreground="#CDD6F4"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="{Binding LoadedFilePath}"
                                       Foreground="#585B70"
                                       FontSize="11"
                                       VerticalAlignment="Center" />
                            <CheckBox Content="Autoscroll"
                                      IsChecked="{Binding AutoScrollSource}"
                                      Foreground="#6C7086"
                                      FontSize="11"
                                      VerticalAlignment="Center" />
                        </StackPanel>
                        <ae:TextEditor Name="SourceEditor"
                                       FontFamily="Cascadia Code,Consolas,Courier New"
                                       FontSize="12"
                                       ShowLineNumbers="True"
                                       IsReadOnly="True" />
                    </DockPanel>
                </Border>
            </Grid>
        </Grid>
    </DockPanel>

</UserControl>
